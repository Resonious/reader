const hashchange = () => {
  if (!location.hash || location.hash.length <= 1) {
    const stored = sessionStorage.getItem('<%= @book.slug %>-page')
    if (stored && stored.length > 0)
      location.hash = stored
    else {
      const first = document.querySelector('article p:first-child')
      location.hash = `#${first.id}`
    }
    return
  }

  const n = location.hash.substr(1)
  let selected

  if (n === 'first') {
    selected = document.querySelector('article p:first-child')
    location.hash = `#${selected.id}`
    return
  }
  else if (n === 'last') {
    selected = document.querySelector('article p:last-child')
    location.hash = `#${selected.id}`
    return
  }
  else
    selected = document.querySelector(`#${n}`)

  for (const el of document.querySelectorAll('.highlight'))
    el.classList.remove('highlight')

  if (selected) {
    selected.classList.add('highlight')
    sessionStorage.setItem('<%= @book.slug %>-page', n)
  }
  else
    sessionStorage.setItem('<%= @book.slug %>-page', null)
}

document.addEventListener('DOMContentLoaded', () => {
  for (const el of document.querySelectorAll('article p')) {
    el.onclick = () => {
      const range = window.getSelection().getRangeAt(0)

      if (range.startOffset === range.endOffset)
        document.location.hash = `#${el.id}`
    }
  }
  for (const el of document.getElementsByClassName('nav-btn')) {
    el.addEventListener('click', () => {
      const anchor = el.href.split('#')[1]
      sessionStorage.setItem('<%= @book.slug %>-page', anchor)
    })
  }
  hashchange()
})

window.addEventListener('hashchange', hashchange)

document.addEventListener('selectionchange', async() => {
  const text = document.getSelection().toString()
  if (!text) return
  if (text.length > 10) return
  if (text.length <= 0) return

  lookupRequest(text, results => window.lookup.$set({results, query: text}))
})
